os:
- linux
language: go
go:
- '1.10'
sudo: required
services:
- docker
- elasticsearch
cache:
  directories:
  - "$GOPATH/pkg"
  - "$GOPATH/src/github.com/ohsu-comp-bio/funnel/.git/modules"
  - "$GOPATH/src/github.com/ohsu-comp-bio/funnel/vendor"
git:
  submodules: false
install:
- make depends
- make
jobs:
  include:
  - stage: upload s3
    all_branches: true
    script:
      - ./build/make-snapshot.sh
      - ls -R build
    deploy:
      provider: s3
      skip_cleanup: true
      access_key_id: AKIAJCP7RTRWV55CDKVQ
      secret_access_key:
        secure: nkjzrW5bg8IstyacRQnwNvcbZbrtr4pxEHRYXBPdKyhaBaS8ykWVeOVGx75fyOupkrboO6YsBdK7xaWjLs9JE161IPz7JY9aB2KwdhXws5A3t1Cr/aTB/Q7nTH71sGn4IZn9hqbpSv1La4G9wQ/46aICY+RvbI0Y/dbcjOBLr/4Ua1CtMNe8YQxqVWuCW/libfCqbvVAGOCZAHMk51FFBCykERxcL/vDEG2BH6wBEYt2CjkY6b6O4X8v3AONFr1vSBno6ubTAc2Ott79aSQaii4291Zrl1J+Dz9ClObcqZK64cDnLAGxWJ7iFoVOu0S1tRhpQXBUsgiSHBVYEX+pNsLtcAVUKpkmLetOaNm6cX3P6dOVetuqrGxUYHR16Oh+hSTbytLcOQyv+6GY+JDWNK4TnYP2Qr8d5zGuqf0IkvoMHgMUtHG51cK2gQ2hTzBoECgVcfvPzbPAen5YfYA5DvXX2w49Jbqr1cVLihY0AgDaRI/M2Kmgnjgy0VlPphEADuIObiMJ23MNzr559NzgzzPrU2CnyzTIY0Sg9mcs+11ROmDHkUCuQOIr3xbASX6fFzdqfC0fcKCaxZkj4HV9Kx94j3NjN4AOrpNCVzp7Ot0jsPrhBhkRE2cGaxJ3X0jt4gO24BULtnLYvLuPoStrV19sgl6qi52DIB/SSB2FirY=
      bucket: funnel-bucket
      local-dir: build/release
      upload-dir: snapshots
      acl: public_read
      all_branches: true
      on:
        all_branches: true
        repo: ohsu-comp-bio/funnel
  - stage: all
    script: make lint
    env:
    - n=lint
  - script: make test
    env:
    - n=test
  - script: make test-htcondor
    env:
    - n=htcondor
  - script: make test-slurm
    env:
    - n=slurm
  - script: make test-gridengine
    env:
    - n=gridengine
  - script: make test-pbs-torque
    env:
    - n=pbs-torque
  - script:
    - make test-badger
    env:
    - n=badger
  - script:
    - sleep 10
    - make test-elasticsearch
    env:
    - n=elasticsearch
  - script:
    - make start-datastore
    - sleep 10
    - make test-datastore
    env:
    - n=datastore
  - script:
    - make start-mongodb
    - sleep 10
    - make test-mongodb
    env:
    - n=mongodb
  - script:
    - make start-dynamodb
    - sleep 10
    - make test-dynamodb
    env:
    - n=dynamodb
  - script:
    - make start-kafka
    - sleep 10
    - make test-kafka
    env:
    - n=kafka
  - script:
    - make start-generic-s3
    - sleep 10
    - make test-generic-s3
    env:
    - n=generic-s3
  - script:
    - make start-pubsub
    - sleep 10
    - make test-pubsub
    env:
    - n=pubsub
notifications:
  email: false
