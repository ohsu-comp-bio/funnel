<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>AWS Batch &middot; Funnel</title>
  

  
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/poole.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/darcula.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/syntax.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/theme.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/funnel.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://ohsu-comp-bio.github.io/funnel/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://ohsu-comp-bio.github.io/funnel/favicon.png">

  <script src="https://ohsu-comp-bio.github.io/funnel/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

  <div class="global-header">
    <div class="global-header-container">
      <div class="global-header-home">
        <a href="https://ohsu-comp-bio.github.io/funnel/"><h1>Funnel</h1></a>
      </div>
      <ul class="global-header-nav">
          <li><a href="https://ohsu-comp-bio.github.io/funnel/download/">Download</a></li>
          <li><a href="https://ohsu-comp-bio.github.io/funnel/docs/">Docs</a></li>
          <li><a href="https://github.com/ohsu-comp-bio/funnel">GitHub</a></li>
          <li><a href="https://gitter.im/ohsu-comp-bio/funnel">Chat</a></li>
          <li><a href="https://ohsu-comp-bio.github.io/funnel-compliance/">Compliance</a></li>
        </ul>
      <div class="global-header-ohsucb">
        <a href="https://www.ohsu.edu/xd/education/schools/school-of-medicine/departments/computational-biology/"><h2>OHSU Comp Bio</h2></a>
      </div>
    </div>
  </div>


<div class="content section group">

  <div class="sidebar col span_3_of_12">
    <ul class="sidebar-nav">
      
      
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/download/"
             class="sidebar-nav-item "
          >Download</a></li>
          
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/docs/"
             class="sidebar-nav-item "
          >Overview</a></li>
          
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/docs/tasks/"
             class="sidebar-nav-item "
          >Tasks</a></li>
          
        
        <li>
          
          <span class="intermediate">Storage</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/local/"
                   class="sidebar-nav-item "
                >Local</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/ftp/"
                   class="sidebar-nav-item "
                >FTP</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/google-storage/"
                   class="sidebar-nav-item "
                >Google Storage</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/http/"
                   class="sidebar-nav-item "
                >HTTP(S)</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/swift/"
                   class="sidebar-nav-item "
                >OpenStack Swift</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/s3/"
                   class="sidebar-nav-item "
                >S3</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Compute</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/deployment/"
                   class="sidebar-nav-item "
                >Deploying a cluster</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/aws-batch/"
                   class="sidebar-nav-item  active"
                >AWS Batch</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/grid-engine/"
                   class="sidebar-nav-item "
                >Grid Engine</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/htcondor/"
                   class="sidebar-nav-item "
                >HTCondor</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/kubernetes/"
                   class="sidebar-nav-item "
                >Kubernetes</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/pbs-torque/"
                   class="sidebar-nav-item "
                >PBS/Torque</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/slurm/"
                   class="sidebar-nav-item "
                >Slurm</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Databases</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/boltdb/"
                   class="sidebar-nav-item "
                >Embedded</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/datastore/"
                   class="sidebar-nav-item "
                >Datastore</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/dynamodb/"
                   class="sidebar-nav-item "
                >DynamoDB</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/elasticsearch/"
                   class="sidebar-nav-item "
                >Elasticsearch</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/mongodb/"
                   class="sidebar-nav-item "
                >MongoDB</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Events</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/events/kafka/"
                   class="sidebar-nav-item "
                >Kafka</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Metrics</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/metrics/prometheus/"
                   class="sidebar-nav-item "
                >Prometheus</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Security</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/security/basic/"
                   class="sidebar-nav-item "
                >Basic Auth</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Development</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/development/developers/"
                   class="sidebar-nav-item "
                >Funnel Developers</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://godoc.org/github.com/ohsu-comp-bio/funnel"
                   class="sidebar-nav-item "
                >Reference</a></li>
            </ul>
          </li>
          
          
        
      
    </ul>
  </div>

  <div class="main col span_8_of_12">
    <h1 id="aws-batch">AWS Batch</h1>
<p>This guide covers deploying a Funnel server that leverages <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html">DynamoDB</a> for storage
and <a href="http://docs.aws.amazon.com/batch/latest/userguide/what-is-batch.html">AWS Batch</a> for task execution.</p>
<h2 id="setup">Setup</h2>
<p>Get started by creating a compute environment, job queue and job definition using either
the Funnel CLI or the AWS Batch web console. To manage the permissions of instanced
AWS Batch jobs create a new IAM role. For the Funnel configuration outlined
in this document, this role will need to provide read and write access to both S3 and DynamoDB.</p>
<p><em>Note</em>: We recommend creating the Job Definition with Funnel by running: <code>funnel aws batch create-job-definition</code>.
Funnel expects the JobDefinition to start a Funnel worker process with a specific configuration.
Only advanced users should consider making any substantial changes to this Job Definition.</p>
<p>AWS Batch tasks, by default, launch the ECS Optimized AMI which includes
an 8GB volume for the operating system and a 22GB volume for Docker image and metadata
storage. The default Docker configuration allocates up to 10GB of this storage to
each container instance. <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html">Read more about the default AMI</a>. Due to these limitations, we
recommend <a href="http://docs.aws.amazon.com/batch/latest/userguide/create-batch-ami.html">creating a custom AMI</a>. Because AWS Batch has the same requirements for your
AMI as Amazon ECS, use the default Amazon ECS-optimized Amazon Linux AMI as a base and change it
to better suit your tasks.</p>
<h3 id="steps">Steps</h3>
<ul>
<li><a href="https://us-west-2.console.aws.amazon.com/batch/home?region=us-west-2#/compute-environments/new">Create a Compute Environment</a></li>
<li>(<em>Optional</em>) <a href="http://docs.aws.amazon.com/batch/latest/userguide/create-batch-ami.html">Create a custom AMI</a></li>
<li><a href="https://us-west-2.console.aws.amazon.com/batch/home?region=us-west-2#/queues/new">Create a Job Queue</a></li>
<li><a href="https://console.aws.amazon.com/iam/home?region=us-west-2#/roles$new?step=permissions&amp;selectedService=EC2ContainerService&amp;selectedUseCase=EC2ContainerTaskRole">Create an EC2ContainerTaskRole with policies for managing access to S3 and DynamoDB</a></li>
<li><a href="https://us-west-2.console.aws.amazon.com/batch/home?region=us-west-2#/job-definitions/new">Create a Job Definition</a></li>
</ul>
<p>For more information check out AWS Batch&rsquo;s <a href="http://docs.aws.amazon.com/batch/latest/userguide/Batch_GetStarted.html">getting started guide</a>.</p>
<h3 id="quickstart">Quickstart</h3>
<pre tabindex="0"><code>$ funnel aws batch create-all-resources --region us-west-2
</code></pre><p>This command will create a compute environment, job queue, IAM role and job definition.</p>
<h2 id="configuring-the-funnel-server">Configuring the Funnel Server</h2>
<p>Below is an example configuration. Note that the <code>Key</code>
and <code>Secret</code> fields are left blank in the configuration of the components. This is because
Funnel will, by default, try to will try to automatically load credentials from the environment.
Alternatively, you may explicitly set the credentials in the config.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">Database</span>: <span style="color:#e6db74">&#34;dynamodb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Compute</span>: <span style="color:#e6db74">&#34;aws-batch&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">EventWriters</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Dynamodb</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">TableBasename</span>: <span style="color:#e6db74">&#34;funnel&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Region</span>: <span style="color:#e6db74">&#34;us-west-2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Secret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Batch</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">JobDefinition</span>: <span style="color:#e6db74">&#34;funnel-job-def&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">JobQueue</span>: <span style="color:#e6db74">&#34;funnel-job-queue&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Region</span>: <span style="color:#e6db74">&#34;us-west-2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Secret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span><span style="color:#f92672">AmazonS3</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Secret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><h3 id="start-the-server">Start the server</h3>
<pre tabindex="0"><code>funnel server run --config /path/to/config.yaml
</code></pre><h3 id="known-issues">Known issues</h3>
<p>The <code>Task.Resources.DiskGb</code> field does not have any effect. See <a href="https://github.com/ohsu-comp-bio/funnel/issues/317">issue 317</a>.</p>

  </div>

</div>
</body>
</html>
