<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>Kubernetes &middot; Funnel</title>
  

  
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/poole.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/darcula.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/syntax.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/theme.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/funnel.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://ohsu-comp-bio.github.io/funnel/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://ohsu-comp-bio.github.io/funnel/favicon.png">

  <script src="https://ohsu-comp-bio.github.io/funnel/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

  <div class="global-header">
    <div class="global-header-container">
      <div class="global-header-home">
        <a href="https://ohsu-comp-bio.github.io/funnel/"><h1>Funnel</h1></a>
      </div>
      <ul class="global-header-nav">
          <li><a href="https://ohsu-comp-bio.github.io/funnel/download/">Download</a></li>
          <li><a href="https://ohsu-comp-bio.github.io/funnel/docs/">Docs</a></li>
          <li><a href="https://github.com/ohsu-comp-bio/funnel">GitHub</a></li>
          <li><a href="https://gitter.im/ohsu-comp-bio/funnel">Chat</a></li>
          <li><a href="https://ohsu-comp-bio.github.io/funnel-compliance/">Compliance</a></li>
        </ul>
      <div class="global-header-ohsucb">
        <a href="https://www.ohsu.edu/xd/education/schools/school-of-medicine/departments/computational-biology/"><h2>OHSU Comp Bio</h2></a>
      </div>
    </div>
  </div>


<div class="content section group">

  <div class="sidebar col span_3_of_12">
    <ul class="sidebar-nav">
      
      
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/download/"
             class="sidebar-nav-item "
          >Download</a></li>
          
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/docs/"
             class="sidebar-nav-item "
          >Overview</a></li>
          
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/docs/tasks/"
             class="sidebar-nav-item "
          >Tasks</a></li>
          
        
        <li>
          
          <span class="intermediate">Storage</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/local/"
                   class="sidebar-nav-item "
                >Local</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/ftp/"
                   class="sidebar-nav-item "
                >FTP</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/google-storage/"
                   class="sidebar-nav-item "
                >Google Storage</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/http/"
                   class="sidebar-nav-item "
                >HTTP(S)</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/swift/"
                   class="sidebar-nav-item "
                >OpenStack Swift</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/s3/"
                   class="sidebar-nav-item "
                >S3</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Compute</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/deployment/"
                   class="sidebar-nav-item "
                >Deploying a cluster</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/aws-batch/"
                   class="sidebar-nav-item "
                >AWS Batch</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/grid-engine/"
                   class="sidebar-nav-item "
                >Grid Engine</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/htcondor/"
                   class="sidebar-nav-item "
                >HTCondor</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/kubernetes/"
                   class="sidebar-nav-item  active"
                >Kubernetes</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/pbs-torque/"
                   class="sidebar-nav-item "
                >PBS/Torque</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/slurm/"
                   class="sidebar-nav-item "
                >Slurm</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Databases</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/boltdb/"
                   class="sidebar-nav-item "
                >Embedded</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/datastore/"
                   class="sidebar-nav-item "
                >Datastore</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/dynamodb/"
                   class="sidebar-nav-item "
                >DynamoDB</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/elasticsearch/"
                   class="sidebar-nav-item "
                >Elasticsearch</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/mongodb/"
                   class="sidebar-nav-item "
                >MongoDB</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Events</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/events/kafka/"
                   class="sidebar-nav-item "
                >Kafka</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Metrics</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/metrics/prometheus/"
                   class="sidebar-nav-item "
                >Prometheus</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Security</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/security/basic/"
                   class="sidebar-nav-item "
                >Basic Auth</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Development</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/development/developers/"
                   class="sidebar-nav-item "
                >Funnel Developers</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://godoc.org/github.com/ohsu-comp-bio/funnel"
                   class="sidebar-nav-item "
                >Reference</a></li>
            </ul>
          </li>
          
          
        
      
    </ul>
  </div>

  <div class="main col span_8_of_12">
    <h1 id="kubernetes">Kubernetes</h1>
<p>This guide will take you through the process of setting up Funnel as a kubernetes service.</p>
<p>Kuberenetes Resources:</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a></li>
<li><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings">Roles and RoleBindings</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">Job</a></li>
</ul>
<p>Additional Funnel deployment resources can be found here: <a href="https://github.com/ohsu-comp-bio/funnel/tree/master/deployments/kubernetes">https://github.com/ohsu-comp-bio/funnel/tree/master/deployments/kubernetes</a></p>
<h4 id="create-a-service">Create a Service:</h4>
<p><em>funnel-service.yml</em></p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  name: funnel
spec:
  selector:
    app: funnel
  ports:
    - name: http
      protocol: TCP
      port: 8000
      targetPort: 8000
    - name: rpc
      protocol: TCP
      port: 9090
      targetPort: 9090
</code></pre><p>Deploy it:</p>
<pre tabindex="0"><code>kubectl apply -f funnel-service.yml
</code></pre><p>Get the clusterIP:</p>
<pre tabindex="0"><code>kubectl get services funnel --output=yaml | grep clusterIP
</code></pre><p>Use this value to configure the server hostname of the worker config.</p>
<h4 id="create-funnel-config-files">Create Funnel config files</h4>
<p><em>Note</em>: The configures job template uses the image, <code>ohsucompbio/funnel-dind:latest</code>, which is built on docker&rsquo;s official <a href="https://hub.docker.com/_/docker">docker-in-docker image (dind)</a>. You can also use the experimental <a href="https://docs.docker.com/engine/security/rootless/">rootless dind variant</a> by changing the image to <code>ohsucompbio/funnel-dind-rootless:latest</code>.</p>
<p><em>funnel-server-config.yml</em></p>
<pre tabindex="0"><code>Database: boltdb

Compute: kubernetes

Logger:
  Level: debug

Kubernetes:
  DisableJobCleanup: false
  DisableReconciler: false
  ReconcileRate: 5m
  Namespace: default
  Template: | 
    apiVersion: batch/v1
    kind: Job
    metadata:
      ## DO NOT CHANGE NAME
      name: {{.TaskId}}
      namespace: {{.Namespace}}
    spec: 
      backoffLimit: 0
      completions: 1
      template:
        spec:
          restartPolicy: Never
          containers: 
            - name: {{printf &#34;funnel-worker-%s&#34; .TaskId}}
              image: ohsucompbio/funnel-dind:latest
              imagePullPolicy: IfNotPresent
              args:
                - &#34;funnel&#34;
                - &#34;worker&#34;
                - &#34;run&#34;
                - &#34;--config&#34;
                - &#34;/etc/config/funnel-worker-config.yml&#34;
                - &#34;--taskID&#34;
                - {{.TaskId}}
              resources:
                  requests:
                    cpu: {{if ne .Cpus 0 -}}{{.Cpus}}{{ else }}{{&#34;100m&#34;}}{{end}}
                    memory: {{if ne .RamGb 0.0 -}}{{printf &#34;%.0fG&#34; .RamGb}}{{else}}{{&#34;16M&#34;}}{{end}}
                    ephemeral-storage: {{if ne .DiskGb 0.0 -}}{{printf &#34;%.0fG&#34; .DiskGb}}{{else}}{{&#34;100M&#34;}}{{end}}
              volumeMounts:
                - name: {{printf &#34;funnel-storage-%s&#34; .TaskId}}
                  mountPath: {{printf &#34;/opt/funnel/funnel-work-dir/%s&#34; .TaskId}}
                - name: config-volume
                  mountPath: /etc/config

              securityContext:
                privileged: true
    
          volumes: 
            - name: {{printf &#34;funnel-storage-%s&#34; .TaskId}}
              emptyDir: {}
            - name: config-volume
              configMap:
                name: funnel-config
</code></pre><p>I recommend setting <code>DisableJobCleanup</code> to <code>true</code> for debugging - otherwise failed jobs will be cleanup up.</p>
<p><em>funnel-worker-config.yml</em></p>
<p><em><strong>Remember to modify the template below to have the actual server hostname.</strong></em></p>
<pre tabindex="0"><code>Database: boltdb

BoltDB:
  Path: /opt/funnel/funnel-work-dir/funnel.bolt.db

Compute: kubernetes

Logger:
  Level: debug

RPCClient:
  MaxRetries: 3
  Timeout: 30s

EventWriters:
  - rpc
  - log

Server:
  HostName: &lt; funnel service clusterIP &gt;
  RPCPort: 9090
</code></pre><h4 id="create-a-configmap">Create a ConfigMap</h4>
<pre tabindex="0"><code>kubectl create configmap funnel-config --from-file=funnel-server-config.yml --from-file=funnel-worker-config.yml
</code></pre><h4 id="create-a-service-account-for-funnel">Create a Service Account for Funnel</h4>
<p>Define a Role and RoleBinding:</p>
<p><em>role.yml</em></p>
<pre tabindex="0"><code>kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: funnel-role
rules:
- apiGroups: [&#34;&#34;]
  resources: [&#34;pods&#34;]
  verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;batch&#34;, &#34;extensions&#34;]
  resources: [&#34;jobs&#34;]
  verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;update&#34;, &#34;patch&#34;, &#34;delete&#34;]
- apiGroups: [&#34;extensions&#34;, &#34;apps&#34;]
  resources: [&#34;deployments&#34;]
  verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;update&#34;, &#34;patch&#34;, &#34;delete&#34;]
</code></pre><p><em>role_binding.yml</em></p>
<pre tabindex="0"><code>kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: funnel-rolebinding
  namespace: default
subjects:
- kind: ServiceAccount
  name: funnel-sa
roleRef:
  kind: Role
  name: funnel-role
  apiGroup: rbac.authorization.k8s.io
</code></pre><p>Create the service account, role and role binding:</p>
<pre tabindex="0"><code>kubectl create serviceaccount funnel-sa --namespace default
kubectl create -f role.yml
kubectl create -f role_binding.yml
</code></pre><h4 id="create-a-deployment">Create a Deployment</h4>
<p><em>funnel-deployment.yml</em></p>
<pre tabindex="0"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: funnel
  labels:
    app: funnel
spec:
  replicas: 1
  selector:
    matchLabels:
      app: funnel
  template:
    metadata:
      labels:
        app: funnel
    spec:
      serviceAccountName: funnel-sa
      containers:
        - name: funnel
          image: ohsucompbio/funnel:latest
          imagePullPolicy: IfNotPresent
          command: 
            - &#39;funnel&#39;
            - &#39;server&#39;
            - &#39;run&#39;
            - &#39;--config&#39;
            - &#39;/etc/config/funnel-server-config.yml&#39;
          resources: 
            requests: 
              cpu: 2 
              memory: 4G
              ephemeral-storage: 25G # needed since we are using boltdb
          volumeMounts:
            - name: funnel-deployment-storage
              mountPath: /opt/funnel/funnel-work-dir
            - name: config-volume
              mountPath: /etc/config
          ports:
            - containerPort: 8000
            - containerPort: 9090

      volumes:
        - name: funnel-deployment-storage
          emptyDir: {}
        - name: config-volume
          configMap:
            name: funnel-config
</code></pre><p>Deploy it:</p>
<pre tabindex="0"><code>kubectl apply -f funnel-deployment.yml
</code></pre><h4 id="proxy-the-service-for-local-testing">Proxy the Service for local testing</h4>
<pre tabindex="0"><code>kubectl port-forward service/funnel 8000:8000
</code></pre><p>Now you can access the funnel server locally. Verify by running:</p>
<pre tabindex="0"><code>funnel task list
</code></pre><p>Now try running a task:</p>
<pre tabindex="0"><code>funnel examples hello-world &gt; hello.json
funnel task create hello.json
</code></pre>
  </div>

</div>
</body>
</html>
